---
layout: post
title: how to use a firefly mv camera with matlab on macos x
date: '2012-06-03T17:40:00.000+02:00'
author: kabamaru
tags:
- libdc1394
- firefly
- camera
- mac
- matlab
modified_time: '2014-01-19T22:59:53.064+01:00'
thumbnail: http://2.bp.blogspot.com/-7SPS5BQ2fvM/T8zobIu5HQI/AAAAAAAAABM/g6a0KeaXS1E/s72-c/matlabfirefly.jpg
blogger_id: tag:blogger.com,1999:blog-950788785801424157.post-5420863707665891544
blogger_orig_url: http://blog.fotiad.is/2012/06/how-to-use-firefly-mv-camera-on-matlab.html
redirect_from:
- http://blog.fotiad.is/2012/06/how-to-use-firefly-mv-camera-on-matlab.html/
- http://kabamaru.blogspot.com/2012/06/how-to-use-firefly-mv-camera-on-matlab.html/
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div><div class="separator" style="clear: both; text-align: center;"></div><a href="http://2.bp.blogspot.com/-7SPS5BQ2fvM/T8zobIu5HQI/AAAAAAAAABM/g6a0KeaXS1E/s1600/matlabfirefly.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://2.bp.blogspot.com/-7SPS5BQ2fvM/T8zobIu5HQI/AAAAAAAAABM/g6a0KeaXS1E/s320/matlabfirefly.jpg" height="262" width="320" /></a>I am developing an algorithm for pedestrian detection using a laser range finder and a camera sensors. Well for the laser I'm limited to the currently available Hokuyo-URG04LX. But since there are quite a lot of cameras available in the lab it's more difficult to choose. The last few days I am messing with a Firefly MV FMVU-03MTM monochrome camera. It has two advantages:</div><div><ol style="text-align: left;"><li>It's very rigid and can be screwed to a base. This is great since we want the camera to be in a fixed position in respect with the laser.</li><li>It has a much much bigger sensor, which mean less noise, and better lense than any other available webcams I've tried. <b>UPDATE: </b>beware<b>&nbsp;</b>that lense comes with a noticable distortion</li></ol></div><div>For the development I'm using matlab but the final implementation will be on opencv and ROS. So I had to see if it works well with these tools. There are a few tutorials already on how to make a Firefly camera work under ubuntu, ros, opencv. If you're interested in this you can have a look&nbsp;<a href="http://bpowers.org/?p=8" target="_blank">here</a>. There is also a matlab mex wrapper for the dc1394 library from barryk, <a href="http://sites.google.com/site/barryk/dc1394mex" target="_blank">here</a>. The problem is that the latter didn't work on my mac.<br />The libdc1394 examples work great but the wrapper doesn't seem to work. I tried downgrading to version 2.0.1 of libddc1394 but this didn't solve the problem either. <strike>So after two days of debugging I decided it's time to write my own wrapper of libdc1394 for matlab.</strike><br /><strike><br /></strike><b>UPDATE</b>: It was too difficult to abandon barryk's wrapper, since it's a great piece of code plus I'm too lazy. So I was using it along with some examples from libdc1394 to understand how I should proceed. After some more (and more and more...) debugging I realized what seem profound from the beginning: the guid of the camera is TOO big to fit into a uint32_t variable. So I changed some declarations and casts, within the camera initiation function, to uint64 and now it works.<br />To compile the whole think I've used the source files from libdc1394 directly, because using the library led matlab to crash. Also I had to make some changes to the filenames to avoid compiler misinterpretations. Here is the compiling command that I've used.<br /><blockquote class="tr_bq"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">/Applications/MATLAB_R2011b.app/bin/mex -g dc1394mex.c bayer.c capture_gen.c control_gen.c conversions.c enumeration.c format7.c internal.c iso.c log.c register.c utils.c &nbsp;-lIOKit -L/opt/local/lib /opt/local/lib/libusb-1.0.dylib -lm &nbsp;-I/opt/local/include/libusb-1.0/ usb/capture_usb.c usb/control_usb.c macosx/control_mac.c macosx/capture_mac.c vendor/avt.c LDFLAGS='$LDFLAGS -framework Carbon -framework CoreFoundation -framework CoreServices' CFLAGS='$CFLAGS -Wall' -o dc1394</span></blockquote>You can ommit the -g parameter. The renames are obvious if you compare them to the original libdc1394 source file/directory structure.&nbsp;This&nbsp;<a href="https://www.dropbox.com/s/rsmf85eoqvfml8i/dc1394.zip" target="_blank">file</a>&nbsp;contains all the source files from libdc1394 you'll need, renamed, plus the dc1394mex with the aforementioned modifications. God speed.<br /><b>UPDATE: </b>I've corrected the function that sets the feature mode and written a new one for setting manual values to them. I've also added support for gamma. I did all this because I had noticed a very strange flickering. At first I thought it might come from auto or semi-auto settings not being calibrated very well so I needed to manually set the features. Nevertheless the problem was caused by the room lighting, see <a href="http://www.ptgrey.com/support/kb/index.asp?a=4&amp;q=38&amp;ST=firefly+mv" target="_blank">here</a> a related article from ptgrey. And <a href="https://www.dropbox.com/s/r7nrjg7dl6t81k5/dc1394mex_v0.3.1.zip" target="_blank">here</a> are the new files.<br /><br />Things I've learned along this way:<br /><blockquote class="tr_bq"><ul style="text-align: left;"><li>writing matlab mex files &nbsp;</li><li>debuging matlab mex files</li><li>steping into external libraries while debuging</li><li>using mac's ioregistryexplorer</li></ul></blockquote></div><div>My setup is:&nbsp;Macbook Unibody Late 2008 with intel core 2 duo,&nbsp;MacOS X Lion 10.7.3, Matlab R2011b</div><div>Libraries: libdc1394-2.2.0, libusb-1.0.8</div></div>